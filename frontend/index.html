<!DOCTYPE html>
<html lang="en">

<head>
    <script>
        // üîí Gatekeeper: Check if user is logged in
        const isLoggedIn = localStorage.getItem("user_logged_in");
        
        // If NOT logged in, kick them to login.html
        if (!isLoggedIn) {
            window.location.href = "login.html";
        }
        
        // Logout Logic (Event listener added in body script)
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JaagrukVoter - Sovereign India Dashboard</title>
    
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Indian-style Typography -->
    <link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700;900&family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --saffron: #FF9933;
            --white: #FFFFFF;
            --green: #138808;
            --navy: #000080;
        }

        body {
            font-family: 'Poppins', sans-serif;
            /* Background with Overlay similar to Login */
            background-image: linear-gradient(rgba(255, 153, 51, 0.9), rgba(255, 255, 255, 0.85), rgba(19, 136, 8, 0.85)), 
                              url('https://images.unsplash.com/photo-1597058712635-3182d1e83116?q=80&w=2500&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
        }
        
        h1, h2, h3, .font-serif { font-family: 'Merriweather', serif; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.5); }
        ::-webkit-scrollbar-thumb { background: var(--navy); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #000060; }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
        }

        /* Ashoka Chakra Animation */
        .chakra-spin {
            animation: spin-slow 20s linear infinite;
        }
        @keyframes spin-slow { 100% { transform: rotate(360deg); } }

        /* Spinner Animation */
        .spinner {
            border: 4px solid rgba(0, 0, 80, 0.1);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border-left-color: var(--saffron);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Mystery Bottle Hover Effect */
        #mysteryBottle {
            transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #mysteryBottle:hover {
            transform: scale(1.1) rotate(10deg);
        }

        /* Chatbox Transition */
        #chatBox {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            opacity: 1;
            transform: translateY(0);
        }
        #chatBox.hidden-chat {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
            pointer-events: none;
            visibility: hidden;
        }

        /* Money Rain Element */
        .money-drop {
            position: fixed;
            top: -50px;
            z-index: 9999;
            pointer-events: none;
            animation: fall linear forwards;
            font-family: serif; /* For Rupee symbol */
        }

        @keyframes fall {
            to {
                transform: translateY(110vh) rotate(360deg);
                opacity: 0;
            }
        }
    </style>
</head>

<body class="text-gray-900 min-h-screen overflow-x-hidden">
    
    <!-- Decorative Chakra Watermark -->
    <div class="fixed -left-24 top-1/4 opacity-5 pointer-events-none z-0">
        <svg class="chakra-spin w-96 h-96 text-blue-900" fill="currentColor" viewBox="0 0 24 24">
            <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm-1-13h2v4h-2zm0 6h2v4h-2z"/>
            <circle cx="12" cy="12" r="3" stroke="currentColor" stroke-width="1" fill="none"/>
            <path d="M12 4V2M12 22v-2M4 12H2m20 0h-2m-2.17-7.83l-1.42-1.42M5.59 18.41l-1.42 1.42M18.41 5.59l1.42-1.42M5.59 5.59L4.17 4.17M19.83 19.83l-1.42-1.42M4.17 19.83l1.42-1.42M19.83 4.17l-1.42 1.42"/>
        </svg>
    </div>

    <!-- Logout Button -->
    <button id="mainLogoutBtn" class="fixed top-4 right-4 z-50 bg-white border border-red-200 text-red-700 hover:bg-red-50 px-4 py-2 rounded-lg shadow-md text-sm font-bold transition-all flex items-center gap-2 hover:shadow-lg">
        <span>Logout</span>
        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
        </svg>
    </button>
    
    <!-- Main container -->
    <main class="container mx-auto max-w-5xl p-4 pt-8 md:pt-16 relative z-10">

        <!-- Header -->
        <header class="text-center mb-10">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-blue-900 text-white rounded-full mb-4 shadow-lg">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M3 10h18M3 7l9-4 9 4M4 10h16v1H4v-1zm0 0V7m16 3V7" />
                </svg>
            </div>
            <h1 class="text-4xl md:text-6xl font-black text-blue-900 tracking-tight drop-shadow-sm">Jaagruk<span class="text-orange-600">Voter</span></h1>
            <p class="text-lg text-gray-800 mt-3 font-medium">Clear, unbiased facts on Indian candidates & policies.</p>
            <div class="w-24 h-1.5 bg-gradient-to-r from-orange-500 via-white to-green-600 mx-auto mt-6 rounded-full border border-gray-300"></div>
        </header>

        <!-- Configuration & Input Section -->
        <section class="glass-panel rounded-2xl p-6 md:p-8 mb-8 border-t-4 border-t-orange-500">
            
            <!-- API Key Input -->
            <div class="mb-8">
                <label for="perplexityApiKey" class="block text-sm font-bold text-gray-700 mb-2">
                    Perplexity API Key <span class="text-red-500">*</span>
                </label>
                <div class="relative">
                    <input type="password" id="perplexityApiKey"
                        class="w-full p-4 pl-5 border border-gray-300 rounded-xl shadow-inner focus:ring-2 focus:ring-orange-500 focus:border-orange-500 transition-all bg-gray-50"
                        placeholder="sk-...">
                    <div class="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-gray-400">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z" clip-rule="evenodd" />
                        </svg>
                    </div>
                </div>
                <p class="text-xs text-gray-500 mt-2 ml-1">Your key is used locally and never stored.</p>
            </div>

            <div class="relative my-10">
                <div class="absolute inset-0 flex items-center" aria-hidden="true">
                    <div class="w-full border-t border-gray-300"></div>
                </div>
                <div class="relative flex justify-center">
                    <span class="bg-white px-4 py-1 text-sm font-bold text-blue-900 rounded-full border border-gray-200 shadow-sm uppercase tracking-wider">Start Your Search</span>
                </div>
            </div>

            <!-- Search Options Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-10">
                
                <!-- Search by Name/Party (Saffron Theme) -->
                <div class="space-y-4">
                    <h3 class="text-xl font-bold text-orange-700 flex items-center border-b border-orange-100 pb-2">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        Search Candidate / Party
                    </h3>
                    <div class="space-y-4">
                        <input type="text" id="searchQuery"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white shadow-sm"
                            placeholder="e.g., Narendra Modi, BJP">
                        
                        <select id="language"
                            class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-orange-500 focus:border-orange-500 bg-white shadow-sm cursor-pointer">
                            <option value="English">English</option>
                            <option value="Hindi">Hindi (‡§π‡§ø‡§®‡•ç‡§¶‡•Ä)</option>
                            <option value="Kannada">Kannada (‡≤ï‡≤®‡≥ç‡≤®‡≤°)</option>
                            <option value="Tamil">Tamil (‡Æ§‡ÆÆ‡Æø‡Æ¥‡Øç)</option>
                            <option value="Telugu">Telugu (‡∞§‡±Ü‡∞≤‡±Å‡∞ó‡±Å)</option>
                        </select>
                        
                        <button id="analyzeButton"
                            class="w-full bg-gradient-to-r from-orange-600 to-orange-500 text-white font-bold py-4 px-6 rounded-xl hover:from-orange-700 hover:to-orange-600 transform transition hover:-translate-y-0.5 shadow-lg active:scale-95 flex items-center justify-center gap-2">
                            <span>Analyze Facts</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M10.293 3.293a1 1 0 011.414 0l6 6a1 1 0 010 1.414l-6 6a1 1 0 01-1.414-1.414L14.586 11H3a1 1 0 110-2h11.586l-4.293-4.293a1 1 0 010-1.414z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>

                <!-- Search by Location (Green Theme) -->
                <div class="space-y-4 md:border-l md:border-gray-200 md:pl-10">
                    <h3 class="text-xl font-bold text-green-700 flex items-center border-b border-green-100 pb-2">
                        <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                        Find Local Reps
                    </h3>
                    <div class="space-y-4">
                        <input type="text" id="locationQuery" 
                            class="w-full p-4 border border-gray-300 rounded-xl focus:ring-2 focus:ring-green-500 focus:border-green-500 bg-white shadow-sm" 
                            placeholder="e.g., Jayanagar, Bengaluru">
                        
                        <!-- Spacer to align buttons if needed, or just margin -->
                        <div class="h-[1px] md:h-[1px]"></div>

                        <button id="findRepsButton"
                            class="w-full bg-gradient-to-r from-green-600 to-green-500 text-white font-bold py-4 px-6 rounded-xl hover:from-green-700 hover:to-green-600 transform transition hover:-translate-y-0.5 shadow-lg active:scale-95 flex items-center justify-center gap-2 mt-auto">
                            <span>Locate MP & MLA</span>
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Status Messages -->
        <div id="loading" class="hidden flex-col justify-center items-center py-10 animate-fade-in bg-white/80 backdrop-blur rounded-xl shadow-sm border border-orange-100">
            <div class="spinner mb-4"></div>
            <p class="text-blue-900 font-bold animate-pulse">Consulting verified sources...</p>
        </div>

        <div id="error" class="hidden bg-red-50 border-l-4 border-red-500 text-red-700 p-6 rounded-r shadow-md mb-6" role="alert">
            <div class="flex">
                <div class="py-1"><svg class="fill-current h-6 w-6 text-red-500 mr-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M2.93 17.07A10 10 0 1 1 17.07 2.93 10 10 0 0 1 2.93 17.07zm12.73-1.41A8 8 0 1 0 4.34 4.34a8 8 0 0 0 11.32 11.32zM9 11V9h2v6H9v-4zm0-6h2v2H9V5z"/></svg></div>
                <div>
                    <p class="font-bold font-serif text-lg">Something went wrong</p>
                    <p id="errorMessage" class="text-sm"></p>
                </div>
            </div>
        </div>

        <!-- Rep Selection (Dynamic) -->
        <section id="rep-selection" class="hidden glass-panel p-6 rounded-xl shadow-lg mb-8 border-t-4 border-green-600">
            <h3 class="text-2xl font-bold text-blue-900 mb-2 font-serif">Representatives Found</h3>
            <p class="text-sm text-gray-600 mb-6">Select a representative to analyze their detailed profile.</p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                <button id="mpButton" class="group relative w-full bg-white border-2 border-orange-100 p-6 rounded-xl hover:border-orange-500 hover:shadow-lg hover:shadow-orange-100 transition-all text-left">
                    <span class="text-xs font-bold text-orange-600 uppercase tracking-wider border border-orange-200 px-2 py-1 rounded-md bg-orange-50">Member of Parliament</span>
                    <div class="text-xl font-bold text-gray-900 mt-3 group-hover:text-orange-700 transition-colors" id="mpNameDisplay">...</div>
                </button>
                <button id="mlaButton" class="group relative w-full bg-white border-2 border-green-100 p-6 rounded-xl hover:border-green-500 hover:shadow-lg hover:shadow-green-100 transition-all text-left">
                    <span class="text-xs font-bold text-green-600 uppercase tracking-wider border border-green-200 px-2 py-1 rounded-md bg-green-50">MLA</span>
                    <div class="text-xl font-bold text-gray-900 mt-3 group-hover:text-green-700 transition-colors" id="mlaNameDisplay">...</div>
                </button>
            </div>
        </section>

        <!-- Results Section -->
        <section id="results" class="hidden glass-panel rounded-xl shadow-2xl overflow-hidden border-t-4 border-blue-900">
            <!-- Tabs -->
            <div class="flex border-b border-gray-200 bg-gray-50/50">
                <button id="tab-summary" class="flex-1 py-4 text-sm font-bold text-blue-900 border-b-4 border-blue-900 bg-white transition-colors uppercase tracking-wide">
                    Fact Sheet
                </button>
                <button id="tab-sources" class="flex-1 py-4 text-sm font-medium text-gray-500 hover:text-blue-900 transition-colors uppercase tracking-wide">
                    Verified Sources
                </button>
            </div>

            <!-- Content Area -->
            <div class="p-6 md:p-10 min-h-[300px] bg-white">
                
                <!-- Summary View -->
                <div id="content-summary">
                    <!-- Dynamic Title -->
                    <div class="flex justify-between items-start mb-8 pb-4 border-b border-gray-100">
                        <h2 id="resultTitle" class="text-3xl font-bold text-blue-900 font-serif">Analysis Result</h2>
                        <button id="copyBtn" class="text-gray-400 hover:text-orange-600 transition-colors p-2 hover:bg-orange-50 rounded-full" title="Copy to Clipboard">
                            <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
                        </button>
                    </div>

                    <!-- Person Specifics -->
                    <div id="person-card" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-orange-50 p-5 rounded-xl border border-orange-100">
                            <span class="block text-xs font-bold text-orange-700 uppercase tracking-wide mb-1">Net Worth</span>
                            <span class="text-2xl font-serif font-bold text-gray-900" id="person-net-worth">-</span>
                        </div>
                        <div class="bg-red-50 p-5 rounded-xl border border-red-100">
                            <span class="block text-xs font-bold text-red-700 uppercase tracking-wide mb-1">Criminal Cases</span>
                            <span class="text-2xl font-serif font-bold text-gray-900" id="person-criminal-cases">-</span>
                        </div>
                        <div class="bg-blue-50 p-5 rounded-xl border border-blue-100">
                            <span class="block text-xs font-bold text-blue-700 uppercase tracking-wide mb-1">Current Party</span>
                            <span class="text-lg font-bold text-gray-900" id="person-current-party">-</span>
                        </div>
                        <div class="bg-gray-50 p-5 rounded-xl border border-gray-200">
                            <span class="block text-xs font-bold text-gray-600 uppercase tracking-wide mb-1">Previous Party</span>
                            <span class="text-lg font-medium text-gray-900" id="person-previous-party">-</span>
                        </div>
                    </div>

                    <!-- Party Specifics -->
                    <div id="party-card" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-orange-50 p-5 rounded-xl border border-orange-100">
                            <span class="block text-xs font-bold text-orange-700 uppercase mb-1">Founded</span>
                            <span class="text-xl font-bold text-gray-900" id="party-year">-</span>
                        </div>
                        <div class="bg-green-50 p-5 rounded-xl border border-green-100">
                            <span class="block text-xs font-bold text-green-700 uppercase mb-1">Founder</span>
                            <span class="text-xl font-bold text-gray-900" id="party-founder">-</span>
                        </div>
                        <div class="bg-blue-50 p-5 rounded-xl border border-blue-100 md:col-span-2">
                            <span class="block text-xs font-bold text-blue-700 uppercase mb-1">Current Leadership</span>
                            <span class="text-xl font-bold text-gray-900" id="party-head">-</span>
                        </div>
                    </div>

                    <!-- General Text Summary -->
                    <div id="summary-text-content" class="prose prose-lg prose-blue max-w-none text-gray-700 leading-relaxed font-sans"></div>
                </div>

                <!-- Sources View -->
                <div id="content-sources" class="hidden">
                    <h3 class="text-xl font-bold text-blue-900 mb-6 font-serif border-b pb-2">Verified Public Sources</h3>
                    <ul id="sourcesOutput" class="space-y-4"></ul>
                </div>
            </div>
        </section>

    </main>

    <!-- Floating UI Elements -->
    
    <!-- Mystery Bottle (Sovereign Chat) -->
    <button id="mysteryBottle" class="fixed bottom-6 right-6 w-16 h-16 bg-gradient-to-br from-blue-900 to-blue-800 text-white rounded-full shadow-2xl flex items-center justify-center z-50 hover:shadow-blue-500/50 outline-none focus:ring-4 focus:ring-blue-300 border-2 border-orange-400">
        <span class="text-2xl">üó≥Ô∏è</span>
    </button>

    <!-- Chat Box -->
    <div id="chatBox" class="hidden-chat fixed bottom-24 right-6 w-80 md:w-96 bg-white rounded-2xl shadow-2xl border-2 border-blue-900 z-40 flex flex-col overflow-hidden max-h-[500px]">
        <!-- Chat Header -->
        <div class="bg-blue-900 p-4 border-b border-blue-800 flex justify-between items-center">
            <h3 class="font-bold text-white flex items-center gap-2 font-serif">
                <span>üáÆüá≥</span> Jaagruk Assistant
            </h3>
            <button id="closeChatBtn" class="text-blue-200 hover:text-white transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>

        <!-- Scrollable Messages -->
        <div id="chatHistory" class="flex-1 overflow-y-auto p-4 space-y-3 bg-slate-50 h-64 text-sm">
            <div class="flex justify-start">
                <div class="bg-white border border-gray-200 text-gray-800 rounded-2xl rounded-tl-none py-3 px-4 max-w-[85%] shadow-sm">
                    Hi! I can read the facts aloud or answer more questions about Indian politics.
                </div>
            </div>
        </div>

        <!-- Audio Controls -->
        <div class="px-4 py-2 bg-gray-50 border-t border-gray-200 flex gap-2">
            <button id="speakFactsBtn" class="flex-1 bg-white border border-blue-200 text-blue-900 hover:bg-blue-50 text-xs font-bold py-2 px-3 rounded-lg transition-colors flex items-center justify-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z"></path></svg>
                Read Facts
            </button>
            <button id="stopSpeakBtn" class="bg-white border border-red-200 text-red-600 hover:bg-red-50 p-2 rounded-lg" title="Stop Speaking">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z"></path></svg>
            </button>
        </div>

        <!-- Input Area -->
        <div class="p-3 bg-white border-t border-gray-200 flex gap-2">
            <input type="text" id="chatInput" class="flex-1 border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-gray-50" placeholder="Ask a question...">
            <button id="sendChatBtn" class="bg-orange-600 text-white rounded-lg px-3 hover:bg-orange-700 transition-colors shadow-md">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path></svg>
            </button>
        </div>
    </div>

    <!-- Application Logic -->
    <script>
        /**
         * JaagrukVoter Application - Consolidated Logic
         */
        const App = (function() {
            // Configuration
            const CONFIG = {
                backendUrl: "https://jaagrukvoter-backend-2.onrender.com/api/search-history",
                perplexityUrl: "https://api.perplexity.ai/chat/completions",
                model: "sonar-pro"
            };

            // State Management
            const state = {
                messages: [{ role: "system", content: "You are JaagrukVoter, a helpful, neutral AI assistant for Indian voters. Keep answers concise." }],
                currentData: null,
                isSpeaking: false
            };

            // DOM Elements Cache
            const DOM = {
                inputs: {
                    apiKey: document.getElementById('perplexityApiKey'),
                    search: document.getElementById('searchQuery'),
                    location: document.getElementById('locationQuery'),
                    language: document.getElementById('language'),
                    chat: document.getElementById('chatInput')
                },
                buttons: {
                    analyze: document.getElementById('analyzeButton'),
                    findReps: document.getElementById('findRepsButton'),
                    bottle: document.getElementById('mysteryBottle'),
                    closeChat: document.getElementById('closeChatBtn'),
                    speak: document.getElementById('speakFactsBtn'),
                    stopSpeak: document.getElementById('stopSpeakBtn'),
                    sendChat: document.getElementById('sendChatBtn'),
                    copy: document.getElementById('copyBtn'),
                    mp: document.getElementById('mpButton'),
                    mla: document.getElementById('mlaButton')
                },
                containers: {
                    loading: document.getElementById('loading'),
                    error: document.getElementById('error'),
                    results: document.getElementById('results'),
                    repSelection: document.getElementById('rep-selection'),
                    chatBox: document.getElementById('chatBox'),
                    chatHistory: document.getElementById('chatHistory'),
                    summary: document.getElementById('content-summary'),
                    sources: document.getElementById('content-sources')
                },
                outputs: {
                    errorMsg: document.getElementById('errorMessage'),
                    summaryText: document.getElementById('summary-text-content'),
                    sourcesList: document.getElementById('sourcesOutput'),
                    personCard: document.getElementById('person-card'),
                    partyCard: document.getElementById('party-card'),
                    mpDisplay: document.getElementById('mpNameDisplay'),
                    mlaDisplay: document.getElementById('mlaNameDisplay'),
                    title: document.getElementById('resultTitle')
                },
                tabs: {
                    summary: document.getElementById('tab-summary'),
                    sources: document.getElementById('tab-sources')
                }
            };

            // --- UTILITIES ---

            const Utils = {
                // Sanitize HTML to prevent XSS (basic version)
                escapeHtml: (text) => {
                    const div = document.createElement('div');
                    div.textContent = text;
                    return div.innerHTML;
                },

                // Simple Markdown Parser for bold text and line breaks
                parseMarkdown: (text) => {
                    if (!text) return '';
                    // Escape HTML first
                    let safeText = Utils.escapeHtml(text);
                    // Bold: **text** -> <b>text</b>
                    safeText = safeText.replace(/\*\*(.*?)\*\*/g, '<b class="font-bold text-blue-900">$1</b>');
                    // Line breaks
                    safeText = safeText.replace(/\n/g, '<br>');
                    return safeText;
                },

                cleanCitation: (text) => {
                    if (!text || text.trim() === "") return "Data not publicly available";
                    return text.replace(/(\[[0-9WQ,\s]+\])+/g, '').replace(/N\/A/gi, '').trim();
                },

                showError: (msg) => {
                    DOM.outputs.errorMsg.textContent = msg;
                    DOM.containers.error.classList.remove('hidden');
                    DOM.containers.loading.classList.add('hidden');
                    DOM.containers.results.classList.add('hidden');
                },

                resetUI: () => {
                    DOM.containers.error.classList.add('hidden');
                    DOM.containers.results.classList.add('hidden');
                    DOM.containers.loading.classList.remove('hidden');
                    DOM.containers.loading.classList.add('flex');
                    DOM.containers.repSelection.classList.add('hidden');
                },

                // Animation: Money Rain
                triggerMoneyRain: () => {
                    for (let i = 0; i < 20; i++) {
                        const money = document.createElement('div');
                        money.textContent = '‚Çπ'; // Changed to Rupee for Indian context
                        money.className = 'money-drop font-bold text-green-600';
                        money.style.left = Math.random() * 100 + 'vw';
                        money.style.fontSize = (Math.random() * 20 + 20) + 'px';
                        money.style.animationDuration = (Math.random() * 2 + 2) + 's';
                        document.body.appendChild(money);
                        // Cleanup
                        setTimeout(() => money.remove(), 4000);
                    }
                }
            };

            // --- API MODULE ---

            const API = {
                getHeaders: (key) => ({
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${key}`
                }),

                logSearch: async (query, type, lang) => {
                    try {
                        await fetch(CONFIG.backendUrl, {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({ query: query.trim(), type, language: lang })
                        });
                    } catch (e) {
                        console.warn("Backend logging failed (non-fatal):", e);
                    }
                },

                fetchWithRetry: async (url, options, retries = 2) => {
                    for (let i = 0; i <= retries; i++) {
                        try {
                            const res = await fetch(url, options);
                            if (res.ok) return res;
                            if (res.status === 401) throw new Error("Invalid API Key");
                            if (res.status >= 500) throw new Error("Server Error");
                        } catch (err) {
                            if (i === retries) throw err;
                            await new Promise(r => setTimeout(r, 1000 * (i + 1))); // Backoff
                        }
                    }
                },

                analyzeEntity: async (query, lang, apiKey) => {
                    const systemPrompt = `You are a non-partisan AI for Indian voters. Identify the entity type (person, party, policy) for "${query}".
                    
                    CRITICAL: You MUST return a JSON object.
                    For 'person' entities (Politicians/Candidates):
                    1. You MUST SEARCH specifically on MyNeta.info, ADR India, and Election Commission (ECI) Affidavits.
                    2. DO NOT return empty strings for 'netWorth' or 'criminalCases'. You MUST find the latest available data.
                    3. If 'criminalCases' is 0, explicitly write "0 Cases". 
                    4. For 'netWorth', provide the value (e.g., "Rs 5 Crore").
                    5. If absolutely no data exists in public records after searching MyNeta/ADR, write "Data not found in affidavits".

                    JSON Structure:
                    {
                      "entityType": "person|party|policy|other",
                      "personDetails": { 
                          "name": "Full Name", 
                          "netWorth": "Value from affidavit (or 'Data not found')", 
                          "criminalCases": "Number/Details (or '0 Cases')", 
                          "currentParty": "Party Name", 
                          "previousParty": "Former Parties (or 'None')" 
                      },
                      "partyDetails": { "name": "", "yearEstablished": "", "founder": "", "head": "" },
                      "generalSummary": "Markdown text summary in ${lang}. Use **bold** for key facts."
                    }`;

                    const response = await API.fetchWithRetry(CONFIG.perplexityUrl, {
                        method: 'POST',
                        headers: API.getHeaders(apiKey),
                        body: JSON.stringify({
                            model: CONFIG.model,
                            messages: [
                                { role: "system", content: systemPrompt },
                                { role: "user", content: `Analyze: ${query}` }
                            ]
                        })
                    });

                    const data = await response.json();
                    return {
                        content: JSON.parse(data.choices[0].message.content.match(/\{[\s\S]*\}/)[0]),
                        sources: data.citations || [] // Newer model might return citations differently, keeping fallback
                    };
                },

                findReps: async (location, apiKey) => {
                    const response = await API.fetchWithRetry(CONFIG.perplexityUrl, {
                        method: 'POST',
                        headers: API.getHeaders(apiKey),
                        body: JSON.stringify({
                            model: CONFIG.model,
                            messages: [
                                { role: "system", content: "Return JSON: {\"mp_name\": \"Name\", \"mla_name\": \"Name\"} for the Indian location provided." },
                                { role: "user", content: `Find MP and MLA for: ${location}` }
                            ]
                        })
                    });
                    const data = await response.json();
                    return JSON.parse(data.choices[0].message.content.match(/\{[\s\S]*\}/)[0]);
                },

                chat: async (history, apiKey) => {
                    const response = await API.fetchWithRetry(CONFIG.perplexityUrl, {
                        method: 'POST',
                        headers: API.getHeaders(apiKey),
                        body: JSON.stringify({ model: CONFIG.model, messages: history })
                    });
                    const data = await response.json();
                    return data.choices[0].message.content;
                }
            };

            // --- UI LOGIC ---

            const UI = {
                renderResults: (data, sources) => {
                    state.currentData = data; // Store for reading
                    DOM.containers.loading.classList.add('hidden');
                    DOM.containers.results.classList.remove('hidden');

                    // Reset sub-cards
                    DOM.outputs.personCard.classList.add('hidden');
                    DOM.outputs.partyCard.classList.add('hidden');

                    // Set Title
                    DOM.outputs.title.textContent = data.entityType === 'person' 
                        ? (data.personDetails?.name || 'Candidate Details') 
                        : (data.partyDetails?.name || 'Analysis Details');

                    // Fill Cards
                    const fill = (id, txt) => {
                        const el = document.getElementById(id);
                        if(el) el.textContent = Utils.cleanCitation(txt || "-");
                    };

                    if (data.entityType === 'person') {
                        DOM.outputs.personCard.classList.remove('hidden');
                        const p = data.personDetails || {};
                        fill('person-net-worth', p.netWorth);
                        fill('person-criminal-cases', p.criminalCases);
                        fill('person-current-party', p.currentParty);
                        fill('person-previous-party', p.previousParty);
                    } else if (data.entityType === 'party') {
                        DOM.outputs.partyCard.classList.remove('hidden');
                        const p = data.partyDetails || {};
                        fill('party-year', p.yearEstablished);
                        fill('party-founder', p.founder);
                        fill('party-head', p.head);
                    }

                    // Render Summary
                    DOM.outputs.summaryText.innerHTML = Utils.parseMarkdown(data.generalSummary);

                    // Render Sources
                    DOM.outputs.sourcesList.innerHTML = '';
                    if (sources && sources.length) {
                        sources.forEach((url, index) => {
                            const li = document.createElement('li');
                            li.className = "text-sm truncate flex items-center gap-2 bg-gray-50 p-2 rounded border border-gray-100";
                            li.innerHTML = `<span class="font-bold text-orange-600 min-w-[24px]">[${index+1}]</span> <a href="${url}" target="_blank" class="text-blue-700 hover:text-orange-600 hover:underline transition font-medium">${url}</a>`;
                            DOM.outputs.sourcesList.appendChild(li);
                        });
                    } else {
                        DOM.outputs.sourcesList.innerHTML = '<li class="text-gray-500 italic">No specific web sources cited.</li>';
                    }

                    Utils.triggerMoneyRain();
                    UI.switchTab('summary');
                },

                switchTab: (tabName) => {
                    const isSum = tabName === 'summary';
                    // Updated classes for tabs to match theme
                    DOM.tabs.summary.className = isSum 
                        ? "flex-1 py-4 text-sm font-bold text-blue-900 border-b-4 border-blue-900 bg-white uppercase tracking-wide" 
                        : "flex-1 py-4 text-sm font-medium text-gray-500 hover:text-blue-900 uppercase tracking-wide";
                    
                    DOM.tabs.sources.className = !isSum 
                        ? "flex-1 py-4 text-sm font-bold text-blue-900 border-b-4 border-blue-900 bg-white uppercase tracking-wide" 
                        : "flex-1 py-4 text-sm font-medium text-gray-500 hover:text-blue-900 uppercase tracking-wide";
                    
                    DOM.containers.summary.classList.toggle('hidden', !isSum);
                    DOM.containers.sources.classList.toggle('hidden', isSum);
                },

                addChatMessage: (sender, text) => {
                    const div = document.createElement('div');
                    div.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
                    
                    const bubble = document.createElement('div');
                    bubble.className = sender === 'user' 
                        ? 'bg-orange-600 text-white rounded-2xl rounded-tr-none py-3 px-4 max-w-[85%] shadow-md' 
                        : 'bg-white border border-gray-200 text-gray-800 rounded-2xl rounded-tl-none py-3 px-4 max-w-[85%] shadow-sm';
                    
                    bubble.innerHTML = Utils.parseMarkdown(text);
                    div.appendChild(bubble);
                    DOM.containers.chatHistory.appendChild(div);
                    DOM.containers.chatHistory.scrollTop = DOM.containers.chatHistory.scrollHeight;
                }
            };

            // --- EVENT HANDLERS ---

            const Handlers = {
                validate: () => {
                    const key = DOM.inputs.apiKey.value.trim();
                    if (!key) {
                        alert("Please enter your Perplexity API Key.");
                        DOM.inputs.apiKey.focus();
                        return null;
                    }
                    return key;
                },

                handleAnalyze: async () => {
                    const apiKey = Handlers.validate();
                    const query = DOM.inputs.search.value.trim();
                    if (!apiKey || !query) return;

                    Utils.resetUI();
                    API.logSearch(query, "entity", DOM.inputs.language.value);

                    try {
                        const { content, sources } = await API.analyzeEntity(query, DOM.inputs.language.value, apiKey);
                        UI.renderResults(content, sources);
                    } catch (e) {
                        Utils.showError(e.message || "Failed to analyze.");
                    }
                },

                handleLocation: async () => {
                    const apiKey = Handlers.validate();
                    const loc = DOM.inputs.location.value.trim();
                    if (!apiKey || !loc) return;

                    Utils.resetUI();
                    API.logSearch(loc, "location", "English");

                    try {
                        const data = await API.findReps(loc, apiKey);
                        DOM.containers.loading.classList.add('hidden');
                        DOM.containers.repSelection.classList.remove('hidden');
                        
                        const setBtn = (btn, display, name) => {
                            display.textContent = name && name !== 'N/A' ? name : 'Not Found';
                            btn.disabled = !name || name === 'N/A';
                            btn.dataset.name = name || "";
                            btn.classList.toggle('opacity-50', btn.disabled);
                            btn.onclick = () => {
                                DOM.inputs.search.value = name;
                                DOM.containers.repSelection.classList.add('hidden');
                                Handlers.handleAnalyze();
                            };
                        };

                        setBtn(DOM.buttons.mp, DOM.outputs.mpDisplay, data.mp_name);
                        setBtn(DOM.buttons.mla, DOM.outputs.mlaDisplay, data.mla_name);

                    } catch (e) {
                        Utils.showError(e.message || "Could not find representatives.");
                    }
                },

                handleChat: async () => {
                    const apiKey = Handlers.validate();
                    const txt = DOM.inputs.chat.value.trim();
                    if (!apiKey || !txt) return;

                    UI.addChatMessage('user', txt);
                    DOM.inputs.chat.value = '';
                    state.messages.push({ role: "user", content: txt });

                    // Loading indicator
                    const loadingDiv = document.createElement('div');
                    loadingDiv.id = 'chat-loading';
                    loadingDiv.className = 'flex justify-start';
                    loadingDiv.innerHTML = '<div class="bg-gray-100 rounded-2xl py-2 px-4 animate-pulse">...</div>';
                    DOM.containers.chatHistory.appendChild(loadingDiv);

                    try {
                        const reply = await API.chat(state.messages, apiKey);
                        state.messages.push({ role: "assistant", content: reply });
                        document.getElementById('chat-loading').remove();
                        UI.addChatMessage('assistant', reply);
                    } catch (e) {
                        document.getElementById('chat-loading').remove();
                        UI.addChatMessage('assistant', "Sorry, error connecting to AI.");
                    }
                },

                handleSpeak: () => {
                    if (state.isSpeaking) {
                        window.speechSynthesis.cancel();
                        state.isSpeaking = false;
                        return;
                    }

                    const text = DOM.outputs.summaryText.innerText;
                    if (!text) return alert("Nothing to read yet.");

                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.onend = () => state.isSpeaking = false;
                    window.speechSynthesis.speak(utterance);
                    state.isSpeaking = true;
                }
            };

            // --- INITIALIZATION ---
            
            const init = () => {
                // Main Buttons
                DOM.buttons.analyze.addEventListener('click', Handlers.handleAnalyze);
                DOM.buttons.findReps.addEventListener('click', Handlers.handleLocation);

                // Tab Switching
                DOM.tabs.summary.addEventListener('click', () => UI.switchTab('summary'));
                DOM.tabs.sources.addEventListener('click', () => UI.switchTab('sources'));

                // Chat & Bottle Toggle
                DOM.buttons.bottle.addEventListener('click', () => DOM.containers.chatBox.classList.remove('hidden-chat'));
                DOM.buttons.closeChat.addEventListener('click', () => DOM.containers.chatBox.classList.add('hidden-chat'));
                
                // Chat Logic
                DOM.buttons.sendChat.addEventListener('click', Handlers.handleChat);
                DOM.inputs.chat.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') Handlers.handleChat();
                });

                // Speech
                DOM.buttons.speak.addEventListener('click', Handlers.handleSpeak);
                DOM.buttons.stopSpeak.addEventListener('click', () => {
                    window.speechSynthesis.cancel();
                    state.isSpeaking = false;
                });

                // Copy
                DOM.buttons.copy.addEventListener('click', () => {
                    navigator.clipboard.writeText(DOM.outputs.summaryText.innerText);
                    alert("Summary copied to clipboard!");
                });
            };

            return { init };
        })();

        // Start App
        document.addEventListener('DOMContentLoaded', App.init);

    </script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const logoutBtn = document.getElementById('mainLogoutBtn');
            
            if (logoutBtn) {
                logoutBtn.addEventListener('click', () => {
                    // 1. Clear the login flag
                    localStorage.removeItem("user_logged_in");
                    // 2. Redirect to login page
                    window.location.href = "login.html";
                });
            } else {
                console.error("Logout button not found in the HTML!");
            }
        });
    </script>
</body>
</html>